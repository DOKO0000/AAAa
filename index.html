<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foto de tu Amigo - Visor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Teko:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Teko', sans-serif;
            background-color: #1a0f24;
            color: white;
            overflow: hidden;
            cursor: crosshair;
        }

        .main-container {
            position: relative;
            background-image: url('https://images.unsplash.com/photo-1518005021863-bd431e9d1754?q=80&w=2670&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); /* Fondo de pared de ladrillos con graffiti */
            background-size: cover;
            background-position: center;
        }

        .main-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Overlay oscuro para que resalte el texto */
            z-index: 1;
        }

        .content-wrapper {
            position: relative;
            z-index: 2; /* Asegura que el contenido esté sobre el overlay */
        }

        .brand-font {
            font-family: 'Roboto Mono', monospace;
        }

        .gradient-text {
            background: linear-gradient(90deg, #f094f8, #a369f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-container input, .form-container button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .form-container input:focus {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: #f094f8;
            outline: none;
            box-shadow: 0 0 15px rgba(240, 148, 248, 0.5);
        }

        .form-container button {
            background: linear-gradient(90deg, #a369f7, #f094f8);
        }

        .form-container button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(240, 148, 248, 0.7);
        }
        
        .image-placeholder {
             background-color: rgba(255, 255, 255, 0.1);
             border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #imagenCredencial {
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        /* Animación de aerosol */
        .spray-particle {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(240, 148, 248, 0.5) 0%, rgba(240, 148, 248, 0) 70%);
            pointer-events: none;
            will-change: transform, opacity;
            animation: fadeOut 1.5s forwards;
        }

        @keyframes fadeOut {
            to {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Estilo del graffiti */
        .graffiti-tag {
            filter: drop-shadow(0 0 5px rgba(240, 148, 248, 0.8)) drop-shadow(0 0 15px rgba(240, 148, 248, 0.5));
            transform: rotate(-15deg);
        }

        .graffiti-logo {
            position: absolute;
            top: 2rem;
            right: 2rem;
            width: 120px; /* Ajusta el tamaño según sea necesario */
            height: auto;
            transform: rotate(10deg); /* Ligeramente rotado */
            filter: drop-shadow(0 0 8px rgba(240, 148, 248, 0.6)); /* Sombra para que resalte */
            z-index: 3; /* Asegurar que esté por encima del overlay */
        }

    </style>
</head>
<body class="w-screen h-screen flex items-center justify-center p-4">

    <audio id="easterEggSound" src="audio2.mp3"></audio>

    <div id="spray-container"></div>

    <div class="main-container w-full max-w-6xl h-full max-h-[800px] rounded-2xl shadow-2xl p-8 md:p-12 overflow-hidden">
       
        <img src="https://i.imgur.com/k9b8rK0.png" alt="Graffiti Logo" class="graffiti-logo">

        <div class="content-wrapper grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16 w-full h-full items-center">
            <div class="text-center md:text-left">
                <h2 class="brand-font text-2xl md:text-3xl tracking-widest text-gray-400 mb-2">DOKO:2037</h2>
                <h1 class="text-6xl sm:text-7xl md:text-8xl font-bold leading-none mb-4">FOTO DE TU AMIGO?</h1>
                <p class="text-2xl md:text-3xl gradient-text font-bold tracking-wide">SOLO OCUPAS LA MATRICULA</p>
            </div>

            <div class="form-container w-full max-w-md mx-auto">
                <div class="space-y-6">
                    <div>
                        <label for="matriculaInput" class="block text-xl uppercase tracking-widest mb-2">Matricula</label>
                        <input type="text" id="matriculaInput" placeholder="Ej: 02308901" class="w-full px-5 py-3 rounded-lg text-lg text-white placeholder-gray-400">
                    </div>
                    
                    <div id="imagenContainer" class="image-placeholder w-full aspect-square rounded-2xl flex items-center justify-center">
                         <img id="imagenCredencial" src="" alt="Foto de credencial aparecerá aquí" class="hidden max-w-full max-h-full rounded-lg object-contain">
                         <span id="image-text" class="text-gray-400">Esperando matrícula...</span>
                    </div>

                    <button onclick="cargarImagen()" class="w-full py-4 rounded-lg text-xl uppercase tracking-widest font-bold">Buscar</button>
                    <button onclick="descargarImagen()" id="descargarBtn" class="w-full py-3 rounded-lg text-lg uppercase tracking-widest font-bold mt-2 hidden">Descargar Imagen</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <script>
        // --- Animación de Aerosol ---
        const sprayContainer = document.body;
        let isSpraying = false;

        function spray(e) {
            if (!isSpraying) return;

            for (let i = 0; i < 5; i++) { // Genera múltiples partículas por evento
                const particle = document.createElement('div');
                particle.classList.add('spray-particle');
                
                const size = Math.random() * 50 + 20;
                const offsetX = (Math.random() - 0.5) * 50;
                const offsetY = (Math.random() - 0.5) * 50;

                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${e.clientX + offsetX}px`;
                particle.style.top = `${e.clientY + offsetY}px`;
                
                sprayContainer.appendChild(particle);

                particle.addEventListener('animationend', () => {
                    particle.remove();
                });
            }
        }

        window.addEventListener('mousedown', () => { isSpraying = true; });
        window.addEventListener('mouseup', () => { isSpraying = false; });
        window.addEventListener('mousemove', spray);


        // --- Lógica de la aplicación (adaptada de tu archivo) ---

        // Configuración de Firebase
        const firebaseConfig = {
            databaseURL: "https://base-de-datos-ip-alupnos-default-rtdb.firebaseio.com/"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // El resto de tu código de Firebase para tracking...
        let userId = localStorage.getItem('userId');
        let userNumber = localStorage.getItem('userNumber');
        
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('userId', userId);
            
            database.ref('userCounter').transaction((current) => {
                return (current || 0) + 1;
            }, (error, committed, snapshot) => {
                if (committed) {
                    userNumber = snapshot.val();
                    localStorage.setItem('userNumber', userNumber);
                    initializeUserProfile();
                }
            });
        } else if (!userNumber) {
            database.ref('userIndex/' + userId).once('value').then((snapshot) => {
                userNumber = snapshot.val();
                if (userNumber) {
                    localStorage.setItem('userNumber', userNumber);
                }
            });
        }

        function initializeUserProfile() {
            const userData = {
                firstVisit: new Date().toISOString(),
                lastVisit: new Date().toISOString(),
                deviceInfo: getDeviceInfo(),
                userId: userId,
                userNumber: userNumber
            };
            database.ref('userIndex/' + userId).set(userNumber);
            database.ref('numberedUsers/' + userNumber).set(userData);
        }

        function getDeviceInfo() {
            return { userAgent: navigator.userAgent, platform: navigator.platform };
        }

        function sendActivityData(type, data = {}) {
            if (!userNumber) return;
            const activityData = {
                timestamp: new Date().toISOString(),
                activityType: type,
                userId: userId,
                userNumber: userNumber,
                ...data
            };
            database.ref('userActivities/' + userNumber).push(activityData);
            database.ref('numberedUsers/' + userNumber + '/lastVisit').set(new Date().toISOString());
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (userNumber) {
                sendActivityData('page_visit', { pageUrl: window.location.href });
            }
        });

        // --- Funciones para cargar y descargar la imagen ---
        
        function cargarImagen() {
            const matriculaInput = document.getElementById('matriculaInput');
            const nuevaMatricula = matriculaInput.value;
            const imagen = document.getElementById('imagenCredencial');
            const imageText = document.getElementById('image-text');

            // --- LÓGICA DEL EASTER EGG (Matrícula: 02308778, Imagen: negro.JPG, Audio: audio2.mp3) ---
            if (nuevaMatricula.trim() === "02308778") {
                
                // 1. Reproducir sonido
                const audio = document.getElementById('easterEggSound');
                if (audio) {
                    audio.play();
                }

                // 2. Mostrar la imagen 'negro.JPG'
                imagen.src = 'negro.JPG';
                imagen.classList.remove('hidden');
                imageText.classList.add('hidden');
                
                // 3. Mostrar botón de descarga
                document.getElementById('descargarBtn').classList.remove('hidden');
                
                // 4. Limpiar el campo de matrícula
                matriculaInput.value = '';

                // 5. Enviar log 
                sendActivityData('search', {
                    matricula: '02308778-EASTEREGG',
                    imageUrl: 'negro.JPG'
                });
                
                // Finaliza la función aquí
                return;
            }
            // -----------------------------------------------------------------

            // Lógica de búsqueda normal
            if (nuevaMatricula) {
                const urlImagen = `https://apps-3.cobachbc.edu.mx/CompetenciasGenericas/Ajax/GetFotoCredencial?pMatricula=${nuevaMatricula}`;
                
                sendActivityData('search', {
                    matricula: nuevaMatricula,
                    imageUrl: urlImagen
                });

                imageText.innerText = "Cargando...";
                imageText.classList.remove('hidden');
                imagen.classList.add('hidden');

                const tempImg = new Image();
                tempImg.src = urlImagen;
                tempImg.onload = () => {
                    imagen.src = urlImagen;
                    imagen.classList.remove('hidden');
                    imageText.classList.add('hidden');
                    document.getElementById('descargarBtn').classList.remove('hidden');
                };
                tempImg.onerror = () => {
                    imageText.innerText = "No se encontró la imagen.";
                };

            } else {
                 imageText.innerText = "Ingresa una matrícula válida.";
            }
        }
        
        // Permitir buscar con la tecla Enter
        document.getElementById('matriculaInput').addEventListener('keyup', function(event) {
            if (event.key === "Enter") {
                cargarImagen();
            }
        });


        function descargarImagen() {
            const imagen = document.getElementById('imagenCredencial');
            const urlImagen = imagen.src;

            if (!urlImagen) return;

            sendActivityData('download', {
                imageUrl: urlImagen
            });
            
            // Para evitar problemas de CORS, se crea un enlace para que el usuario descargue
            const link = document.createElement('a');
            link.href = urlImagen;
            link.target = '_blank'; // Abrir en nueva pestaña para que el navegador gestione la descarga
            
            // Si es la imagen del easter egg, usa un nombre de archivo específico
            if (urlImagen.includes('negro.jpg')) {
                link.download = 'negro.jpg';
            } else {
                // Si no es el easter egg, usa la matrícula como nombre del archivo
                link.download = document.getElementById('matriculaInput').value + '.png' || 'credencial.png';
            }

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

</body>
</html>
