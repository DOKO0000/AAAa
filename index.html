<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro e Inicio de Sesión</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            margin: 10px 0;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        button:hover {
            background-color: #2980b9;
        }
        #mensajeError {
            color: red;
            text-align: center;
            display: none; /* Initially hidden */
        }
        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>Registro e Inicio de Sesión</h1>
    
    <h2>Registro</h2>
    <input type="text" id="matriculaRegistro" placeholder="Ingresa tu matrícula (8 dígitos)">
    <input type="password" id="contrasenaRegistro" placeholder="Ingresa tu contraseña">
    <button onclick="registrarUsuario()">Registrar</button>
    
    <h2>Inicio de Sesión</h2>
    <input type="text" id="matriculaLogin" placeholder="Ingresa tu matrícula (8 dígitos)">
    <input type="password" id="contrasenaLogin" placeholder="Ingresa tu contraseña">
    <button onclick="iniciarSesion()">Iniciar Sesión</button>
    
    <div id="mensajeError"></div>
    
    <script>
        const databaseURL = "https://fotocredencial-30d54-default-rtdb.firebaseio.com/";

        function validarMatricula(matricula) {
            return fetch(`https://apps-3.cobachbc.edu.mx/CompetenciasGenericas/Ajax/GetFotoCredencial?pMatricula=${matricula}`)
                .then(response => {
                    return response.ok; // Verifica si la respuesta es exitosa
                });
        }

        function registrarUsuario() {
            const matricula = document.getElementById('matriculaRegistro').value;
            const contrasena = document.getElementById('contrasenaRegistro').value;
            const mensajeError = document.getElementById('mensajeError');

            // Validar matrícula
            if (!/^\d{8}$/.test(matricula)) {
                mensajeError.textContent = "La matrícula debe ser de 8 dígitos numéricos.";
                mensajeError.style.display = "block";
                return;
            }

            // Validar matrícula en la URL
            validarMatricula(matricula).then(isValid => {
                if (!isValid) {
                    mensajeError.textContent = "La matrícula no es válida o no refleja una imagen.";
                    mensajeError.style.display = "block";
                    return;
                }

                // Guardar en la base de datos
                fetch(`${databaseURL}usuarios.json`, {
                    method: 'POST',
                    body: JSON.stringify({ matricula: matricula, contrasena: contrasena }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert("Registro exitoso. Puedes iniciar sesión.");
                        document.getElementById('matriculaRegistro').value = '';
                        document.getElementById('contrasenaRegistro').value = '';
                    } else {
                        mensajeError.textContent = "Error al registrar. Inténtalo de nuevo.";
                        mensajeError.style.display = "block";
                    }
                })
                .catch(error => {
                    mensajeError.textContent = "Error de conexión. Inténtalo de nuevo.";
                    mensajeError.style.display = "block";
                });
            });
        }

        function iniciarSesion() {
            const matricula = document.getElementById('matriculaLogin').value;
            const contrasena = document.getElementById('contrasenaLogin').value;
            const mensajeError = document.getElementById('mensajeError');

            // Validar matrícula
            if (!/^\d{8}$/.test(matricula)) {
                mensajeError.textContent = "La matrícula debe ser de 8 dígitos numéricos.";
                mensajeError.style.display = "block";
                return;
            }

            // Verificar en la base de datos
            fetch(`${databaseURL}usuarios.json`)
            .then(response => response.json())
            .then(data => {
                const usuarios = Object.values(data);
                const usuarioEncontrado = usuarios.find(usuario => usuario.matricula === matricula && usuario.contrasena === contrasena);
                
                if (usuarioEncontrado) {
                    alert("Inicio de sesión exitoso.");
                    // Redirigir a la página principal
                    window.location.href = "/index (3).html"; // Cambia esto a la URL correcta
                } else {
                    mensajeError.textContent = "Matrícula o contraseña incorrectos. Por favor, intenta de nuevo.";
                    mensajeError.style.display = "block";
                }
            })
            .catch(error => {
                mensajeError.textContent = "Error de conexión. Inténtalo de nuevo.";
                mensajeError.style.display = "block";
            });
        }
    </script>

    <footer>
        © 2048 / DOKO.POLO
    </footer>
</body>
</html>
